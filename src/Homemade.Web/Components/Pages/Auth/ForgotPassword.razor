@page "/forgot-password"
@rendermode InteractiveServer

<PageTitle>Forgot Password - Homemade</PageTitle>

<div class="min-h-screen bg-gradient-to-b from-primary-50 to-white flex items-center justify-center px-4 py-12">
    <div class="w-full max-w-md">
        <!-- Back to Login -->
        <a href="/login" class="inline-flex items-center text-neutral-600 hover:text-primary-600 mb-6 transition-colors">
            <span class="mr-2">‚Üê</span> Back to login
        </a>

        <!-- Forgot Password Card -->
        <div class="bg-white rounded-2xl shadow-lg p-8">
            @if (!emailSent)
            {
                <!-- Initial State - Request Reset -->
                <div class="text-center mb-8">
                    <div class="text-5xl mb-3">üîí</div>
                    <h1 class="text-3xl font-bold text-neutral-900 mb-2">Forgot Password?</h1>
                    <p class="text-neutral-600">No worries, we'll send you reset instructions</p>
                </div>

                <form @onsubmit="HandleForgotPassword" @onsubmit:preventDefault>
                    <!-- Email Field -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-neutral-700 mb-2">
                            Email Address
                        </label>
                        <input
                            type="email"
                            placeholder="your@email.com"
                            class="w-full px-4 py-3 border-2 rounded-xl transition-colors @(emailError ? "border-error-300 focus:border-error-500" : "border-neutral-200 focus:border-primary-500") focus:outline-none"
                            @bind="email"
                            @oninput="() => emailError = false"
                            required
                        />
                        @if (emailError)
                        {
                            <p class="mt-1 text-sm text-error-700">@errorMessage</p>
                        }
                    </div>

                    <!-- Submit Button -->
                    <button
                        type="submit"
                        class="w-full py-3 bg-primary-500 text-white font-semibold rounded-xl hover:bg-primary-600 transition-colors disabled:bg-neutral-300 disabled:cursor-not-allowed mb-6"
                        disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span>Sending...</span>
                        }
                        else
                        {
                            <span>Send Reset Link</span>
                        }
                    </button>

                    <!-- Back to Login Link -->
                    <div class="text-center">
                        <a href="/login" class="inline-flex items-center text-primary-600 hover:text-primary-700 font-semibold transition-colors">
                            <span class="mr-1">‚Üê</span> Back to log in
                        </a>
                    </div>
                </form>
            }
            else
            {
                <!-- Success State - Email Sent -->
                <div class="text-center">
                    <div class="w-16 h-16 bg-success-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-success-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-neutral-900 mb-2">Check Your Email</h1>
                    <p class="text-neutral-600 mb-8">
                        We've sent password reset instructions to<br/>
                        <span class="font-semibold text-neutral-800">@email</span>
                    </p>

                    <div class="p-4 bg-neutral-50 rounded-lg mb-6">
                        <p class="text-sm text-neutral-700 mb-2">Didn't receive the email?</p>
                        <button
                            class="text-sm text-primary-600 hover:text-primary-700 font-semibold transition-colors"
                            @onclick="ResendEmail"
                            disabled="@(resendCooldown > 0)">
                            @if (resendCooldown > 0)
                            {
                                <span>Resend in @resendCooldown seconds</span>
                            }
                            else
                            {
                                <span>Click to resend</span>
                            }
                        </button>
                    </div>

                    <a href="/login" class="inline-flex items-center text-primary-600 hover:text-primary-700 font-semibold transition-colors">
                        <span class="mr-1">‚Üê</span> Back to log in
                    </a>
                </div>
            }
        </div>

        <!-- Help Text -->
        @if (!emailSent)
        {
            <div class="mt-6 text-center">
                <p class="text-sm text-neutral-600">
                    Enter the email address associated with your account and we'll send you a link to reset your password.
                </p>
            </div>
        }
    </div>
</div>

@code {
    private string email = "";
    private bool emailError = false;
    private string errorMessage = "";
    private bool isLoading = false;
    private bool emailSent = false;
    private int resendCooldown = 0;

    private async Task HandleForgotPassword()
    {
        // Reset errors
        emailError = false;
        errorMessage = "";

        // Validate email
        if (string.IsNullOrWhiteSpace(email))
        {
            emailError = true;
            errorMessage = "Email is required";
            return;
        }

        if (!email.Contains("@"))
        {
            emailError = true;
            errorMessage = "Please enter a valid email address";
            return;
        }

        // Mock sending reset email
        isLoading = true;
        await Task.Delay(1500); // Simulate API call
        isLoading = false;

        // TODO: Replace with actual password reset logic
        // For now, always succeed
        emailSent = true;
        resendCooldown = 60;
        StartResendCooldown();
    }

    private async void StartResendCooldown()
    {
        while (resendCooldown > 0)
        {
            await Task.Delay(1000);
            resendCooldown--;
            StateHasChanged();
        }
    }

    private async Task ResendEmail()
    {
        if (resendCooldown > 0) return;

        // Mock resending email
        isLoading = true;
        await Task.Delay(1000);
        isLoading = false;

        // TODO: Replace with actual resend logic
        resendCooldown = 60;
        StartResendCooldown();
    }
}
